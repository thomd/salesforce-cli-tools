#!/usr/bin/env bash

#
# USAGE
#
#     sf-deploy -o ALIAS            # deploy package based to ALIAS org [default: b2bdev2]
#     sf-deploy -c                  # validate deployment with unit tests
#

yesno() {
  echo ""
  read -p "$1 [Y/n] " response
  [[ $response == "n" || $response == "N" ]] && exit 1
}

org="b2bdev2"
validate="false"

while [ $# -gt 0 ]; do
  case $1 in
    -o)
      shift
      org=$1
      ;;
    -c)
      validate="true"
      ;;
    -h|--help)
      cat $0 | sed -n '/^#/p' | sed '/^##/d' | sed 1d | sed 's/^#/ /g' \
        | perl -pe "s/ #(.*)$/$(tput setaf 0)\1$(tput sgr 0)/" \
        | perl -pe "s/(USAGE|EXAMPLES)/$(tput setaf 8)\1$(tput sgr0)/"
      exit 1
      ;;
    *)
      ;;
  esac
  shift
done

if [[ $validate == "true" ]]; then
  yesno " Verify Deployment on $(tput setaf 1)${org}$(tput sgr0) ?"
  echo -e "\n $(tput setaf 2)Verify Deployment$(tput sgr0) ..."
  sfdx project deploy validate -x manifest/package.xml -l RunSpecifiedTests -t `cat scripts/test/unit-test-list.txt | sed s/,$// | awk '{ printf(" -t %s", $0) }'` -o ${org} > result.tmp
  cat result.tmp | cut -c -$(tput cols)
  deployid=$(cat result.tmp | grep "Deploy ID" | perl -pe 's/Deploy ID: (.*)/\1/')
  deployurl="https://mediverse--b2bdev1.sandbox.lightning.force.com/lightning/setup/DeployStatus/page?address=/changemgmt/monitorDeploymentsDetails.apexp?asyncId=${deployid}"
  echo -e "Ëœn $(tput setaf 1)Deployment Status:$(tput sgr0) ${deployurl}"
  rm result.tmp
else
  yesno " Deploy to $(tput setaf 1)${org}$(tput sgr0) ?"
  echo -e "\n $(tput setaf 2)Build Frontend CSS$(tput sgr0) ..."
  (cd frontend && npm run frontend:build >/dev/null)
  echo " $(tput setaf 2)Deploy$(tput sgr0) ..."
  sfdx project deploy start -x manifest/package.xml -o ${org} > /dev/null
  if [[ $? == 0 ]]; then
    echo " $(tput setaf 2)Publish$(tput sgr0) ..."
    name=$(sfdx data query -o ${org} -q "SELECT Name FROM Site WHERE UrlPathPrefix=''" --json | jq -r '.result.records[].Name')
    sfdx community publish -n ${name} -o ${org} >/dev/null
    git restore force-app/main/default/staticresources/b2bTheme.css
    domain=$(sfdx data query -o ${org} -q "SELECT Domain FROM Domain WHERE HttpsOption='CommunityAlt'" --json | jq -r '.result.records[].Domain')
    echo " $(tput setaf 2)Finish$(tput sgr0): ${domain}"
  else
    echo " $(tput setaf 1)Deployment Error$(tput sgr0)"
  fi
fi

